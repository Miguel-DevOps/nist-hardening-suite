name: Ansible Lint & YAML Validation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core==2.16.0 ansible-lint==6.22.2 yamllint==1.35.1

      - name: Run ansible-lint on playbooks
        id: ansible-lint
        run: |
          ansible-lint \
            --config-file .ansible-lint \
            stacks.yml monitoring.yml nuke.yml
        continue-on-error: true

      - name: Run yamllint on YAML files
        id: yamllint
        run: |
          yamllint -c .yamllint \
            --format colored \
            --strict \
            . \
            2>&1 | tee yamllint_report.txt
        continue-on-error: true

      - name: Check Ansible version compatibility
        run: |
          ansible --version
          ansible-inventory --list

      - name: Validate playbook syntax
        run: |
          ansible-playbook --syntax-check stacks.yml
          ansible-playbook --syntax-check monitoring.yml
          ansible-playbook --syntax-check nuke.yml

      - name: Report results to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = '## ðŸ” Code Quality Report\n\n';
            
            body += '### Ansible Lint\n';
            if ('${{ steps.ansible-lint.outcome }}' === 'success') {
              body += 'âœ… All playbooks passed linting\n\n';
            } else {
              body += 'âš ï¸ Ansible Lint issues detected (see logs)\n\n';
            }
            
            body += '### YAML Validation\n';
            if ('${{ steps.yamllint.outcome }}' === 'success') {
              body += 'âœ… All YAML files valid\n\n';
            } else {
              body += 'âš ï¸ YAML validation warnings (see logs)\n\n';
            }
            
            body += '**Security Note:** This project enforces NIST 800-53 compliance\n';
            body += '- All code changes are subject to security audit\n';
            body += '- See [CONTRIBUTING.md](CONTRIBUTING.md) for guidelines\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail on critical lint errors
        if: steps.ansible-lint.outcome == 'failure' || steps.yamllint.outcome == 'failure'
        run: |
          echo "âŒ Code quality checks failed"
          echo "Please fix the issues above before merging"
          exit 1

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-reports-py${{ matrix.python-version }}
          path: |
            yamllint_report.txt

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install secret detection tool
        run: |
          pip install detect-secrets==1.5.0

      - name: Scan for exposed secrets
        id: detect-secrets
        run: |
          detect-secrets scan \
            --baseline .secrets.baseline \
            --exclude-files roles/.*/(defaults|vars)/.*\.yml$ \
            --exclude-files group_vars/
        continue-on-error: true

      - name: Fail if secrets detected
        if: steps.detect-secrets.outcome == 'failure'
        run: |
          echo "âŒ Potential secrets detected in commit"
          echo "Do not commit secrets to version control"
          echo "Use Ansible Vault or environment variables instead"
          exit 1

  ansible-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Ansible
        run: |
          pip install ansible-core==2.16.0

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install -r requirements.yml

      - name: Verify playbook structure
        run: |
          echo "Checking playbook structure..."
          ansible-playbook --list-hosts stacks.yml 2>&1 | grep -E "hosts|FATAL" || true
          ansible-playbook --list-hosts monitoring.yml 2>&1 | grep -E "hosts|FATAL" || true

      - name: Validate inventory format
        run: |
          if [ -f inventory/hosts.ini ]; then
            ansible-inventory -i inventory/hosts.ini --list > /dev/null
            echo "âœ… Inventory valid"
          fi
