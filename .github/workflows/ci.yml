name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-validate:
    name: Lint, Validate & Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          ansible-galaxy collection install -r requirements.yml

      - name: Run ansible-lint
        run: |
          ansible-lint stacks.yml monitoring.yml nuke.yml

      - name: Run yamllint
        run: |
          yamllint .

      - name: Validate playbook syntax
        run: |
          echo "üîç Validating playbook syntax..."
          ansible-playbook --syntax-check site.yml
          ansible-playbook --syntax-check stacks.yml
          ansible-playbook --syntax-check monitoring.yml
          ansible-playbook --syntax-check nuke.yml
          echo "‚úÖ All playbooks have valid syntax"

      - name: Scan for exposed secrets
        run: |
          pip install detect-secrets
          
          echo "üîç Scanning for secrets with detect-secrets..."
          detect-secrets scan \
            --baseline .secrets.baseline \
            --exclude-files roles/.*/(defaults|vars)/.*\.yml \
            --exclude-files group_vars/.*\.yml \
            --all-files \
            2>&1 | tee detect-secrets-output.txt
          
          if grep -q "\"results\": {}" detect-secrets-output.txt; then
            echo "‚úÖ No new secrets detected"
          else
            echo "‚ùå Potential secrets detected"
            echo "Do not commit secrets to version control"
            echo "Use Ansible Vault or environment variables instead"
            exit 1
          fi

  validate-roles:
    name: Validate Role Structure
    runs-on: ubuntu-latest
    strategy:
      matrix:
        role: [common, security, docker, tailscale_client, crowdsec, compliance, observability, stack_ingress, stack_portainer]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          ansible-galaxy collection install -r requirements.yml

      - name: Validate role structure
        run: |
          if [ -f "roles/${{ matrix.role }}/tasks/main.yml" ]; then
            echo "‚úÖ Role ${{ matrix.role }}: Structure valid"
            ansible-lint "roles/${{ matrix.role }}"
          else
            echo "‚ö†Ô∏è  Role ${{ matrix.role }}: No executable tasks"
          fi

  convergence-check:
    name: Convergence & Idempotency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          ansible-galaxy collection install -r requirements.yml

      - name: Final playbook syntax validation
        run: |
          echo "üîç Final convergence check..."
          ansible-playbook --syntax-check \
            -i inventory/hosts.ini \
            site.yml stacks.yml monitoring.yml nuke.yml
          echo "‚úÖ Convergence test passed"

